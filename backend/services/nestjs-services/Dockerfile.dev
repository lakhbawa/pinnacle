FROM node:22-alpine

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apk add --no-cache \
    bash \
    curl \
    unzip \
    protobuf \
    protobuf-dev \
    git \
    python3 \
    make \
    g++ \
    # Install Prisma and Nest CLI globally
    && npm install -g @nestjs/cli prisma

# Copy package files
COPY package*.json ./

# Install all dependencies (including dev)
RUN npm ci

# Copy source code
COPY . .

# Build argument for service name
ARG SERVICE_NAME
ENV SERVICE_NAME=${SERVICE_NAME}

# Generate Prisma client for the specific service
RUN npx prisma generate --schema=./apps/${SERVICE_NAME}/prisma/schema.prisma \
    --config=./apps/${SERVICE_NAME}/prisma.config.ts

# Default command: run NestJS in dev mode for the specific service
CMD ["sh", "-c", "npm run start:dev ${SERVICE_NAME}"]
